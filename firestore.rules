rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isStaff() {
      // Role-Based Access Control via 'users' collection lookup
      // Note: We use a more resilient check that defaults to false if document doesn't exist
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null && (userDoc.data.role == 'STAFF' || userDoc.data.role == 'ADMIN');
    }

    // --- COLLECTION RULES ---

    // Users: Public read (for search), Write own or Staff
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isStaff();
    }

    // Athletes: Private (Owner/Staff only)
    match /athletes/{athleteId} {
      allow read, write: if isOwner(athleteId) || isStaff();
    }
    
    // Plans: Staff writes, Athlete reads
    match /plans/{athleteId} {
      allow read: if isOwner(athleteId) || isStaff();
      allow write: if isStaff();
    }
    
    // Macrocycles: Staff writes, Athlete reads
    match /macrocycles/{athleteId} {
      allow read: if isOwner(athleteId) || isStaff();
      allow write: if isStaff();
    }
    
    // Chats: Flexible Room IDs (Staff_Athlete)
    match /chats/{roomId} {
      // Room ID format: {UID1}_{UID2}
      function isParticipant() {
        let parts = roomId.split('_');
        return parts.size() == 2 && 
               (parts[0] == request.auth.uid || parts[1] == request.auth.uid);
      }
      
      // Fallback for array-based check if ID is not formatted
      function isParticipantInArray() {
        return resource != null && request.auth.uid in resource.data.participants;
      }
      
      allow read, write: if isAuthenticated() && (isParticipant() || isParticipantInArray() || isStaff());
      
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && (isParticipant() || isStaff());
      }
    }
    
    // Notifications: User reads/writes own, authenticated can create
    match /notifications/{notificationId} {
      // Use resource.data check safely
      allow read, update, delete: if isAuthenticated() && (resource == null || resource.data.userId == request.auth.uid);
      allow create: if isAuthenticated();
    }
    
    // Activities: Authenticated users can read/create
    match /activities/{activityId} {
      allow read, create: if isAuthenticated();
      allow update, delete: if isStaff();
    }
    
    // Staff internal docs
    match /staff/{document=**} {
      allow read, write: if isStaff();
    }
  }
}

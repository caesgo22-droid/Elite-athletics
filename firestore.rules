rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isStaff() {
      // Role-Based Access Control via 'users' collection lookup
      // Note: This incurs a read cost. For high-scale, migrate to Custom Claims.
      let role = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return role == 'STAFF' || role == 'ADMIN';
    }

    // --- COLLECTION RULES ---

    // Users: Public read (for search), Write own or Staff
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isStaff();
    }

    // Athletes: Private (Owner/Staff only)
    match /athletes/{athleteId} {
      allow read: if isOwner(athleteId) || isStaff();
      allow write: if isOwner(athleteId) || isStaff(); // Needed for LinkRequest acceptance
    }
    
    // Plans: Staff writes, Athlete reads
    match /plans/{athleteId} {
      allow read: if isOwner(athleteId) || isStaff();
      allow write: if isStaff(); // Athletes shouldn't modify their prescribed plan (usually)
    }
    
    // Macrocycles: Staff writes, Athlete reads
    match /macrocycles/{athleteId} {
      allow read: if isOwner(athleteId) || isStaff();
      allow write: if isStaff();
    }
    
    // Chats: Flexible Room IDs (Staff_Athlete)
    match /chats/{roomId} {
      allow read, write: if isAuthenticated(); // Validation logic moved to App/Functions
      
      match /messages/{messageId} {
        allow read, write: if isAuthenticated();
      }
    }
    
    // Staff internal docs
    match /staff/{document=**} {
      allow read, write: if isStaff();
    }
  }
}
